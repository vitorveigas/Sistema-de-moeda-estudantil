<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Aluno - Sistema de Moedas Estudantis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { color: #333; font-size: 2rem; display: flex; align-items: center; gap: 1rem; }
        .header h1 i { color: #667eea; }
        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px;
            cursor: pointer; font-weight: 600; transition: all 0.3s ease;
        }
        .logout-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,107,107,0.3); }
        .tabs {
            display: flex; margin-bottom: 2rem; background: white;
            border-radius: 15px; padding: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .tab {
            flex: 1; padding: 1rem; text-align: center; background: transparent;
            border: none; cursor: pointer; border-radius: 10px; font-weight: 600;
            transition: all 0.3s ease; color: #666;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: white; border-radius: 20px; padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 2rem;
        }
        .card h2 { color: #333; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .card h2 i { color: #667eea; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 1rem 2rem; border-radius: 10px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.3); }
        .result-card { background: #f8f9fa; padding: 1.5rem; border-radius: 15px; border-left: 4px solid #667eea; margin-bottom: 1rem; }
        .result-card h4 { color: #333; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 1rem; }
        .result-item { background: white; padding: 0.75rem; border-radius: 8px; border: 1px solid #e1e5e9; }
        .result-item strong { color: #667eea; display: block; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .result-item span { color: #333; font-size: 0.95rem; }
        .input-container { position: relative; margin-bottom: 1rem; }
        .input-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        input, select { width: 100%; padding: 1rem 1rem 1rem 45px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: #fafbfc; }
        input:focus, select:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fas fa-user-graduate"></i> Dashboard do Aluno</h1>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('saldo')">Saldo</button>
        <button class="tab" onclick="showTab('historico')">Histórico</button>
        <button class="tab" onclick="showTab('vantagens')">Resgatar Vantagens</button>
        <button class="tab" onclick="showTab('conta')">Conta</button>
    </div>

    <!-- Saldo -->
    <div id="saldo" class="tab-content active">
        <div class="card">
            <h2><i class="fas fa-coins"></i> Saldo de Moedas</h2>
            <div id="saldoMoedas" class="result-card">
                <h4>Saldo Atual:</h4>
                <span>0 moedas</span>
            </div>
        </div>
    </div>

    <!-- Histórico -->
    <div id="historico" class="tab-content">
        <div class="card">
            <h2><i class="fas fa-history"></i> Histórico de Transações</h2>
            <div id="historicoTransacoes"></div>
        </div>
    </div>

    <!-- Resgatar Vantagens -->
    <div id="vantagens" class="tab-content">
        <div class="card">
            <h2><i class="fas fa-gift"></i> Resgatar Vantagens</h2>
            <form id="resgatarForm">
                <div class="input-container">
                    <i class="fas fa-gift"></i>
                    <select id="vantagemSelect" required>
                        <option value="">Selecione uma vantagem</option>
                    </select>
                </div>
                <button type="submit" class="btn">Resgatar</button>
            </form>
            <div id="resgatarMessage"></div>
        </div>
    </div>
</div>

<!-- Minha Conta -->
<!-- Minha Conta -->
<div id="conta" class="tab-content">
    <div class="card">
        <h2><i class="fas fa-user"></i> Minha Conta</h2>
        <form id="accountForm">
            <div class="input-container">
                <i class="fas fa-user"></i>
                <input type="text" id="name" placeholder="Nome" required>
            </div>
            <div class="input-container">
                <i class="fas fa-envelope"></i>
                <input type="email" id="email" placeholder="Email" required>
            </div>
            <div class="input-container">
                <i class="fas fa-id-card"></i>
                <input type="text" id="matricula" placeholder="Matrícula" required readonly>
            </div>
            <div class="input-container">
                <i class="fas fa-book"></i>
                <input type="text" id="curso" placeholder="Curso" required>
            </div>
            <div class="input-container">
                <i class="fas fa-id-badge"></i>
                <input type="text" id="cpf" placeholder="CPF" required readonly>
            </div>
            <div class="input-container">
                <i class="fas fa-id-badge"></i>
                <input type="text" id="rg" placeholder="RG" readonly>
            </div>
            <div class="input-container">
                <i class="fas fa-university"></i>
                <input type="text" id="instituicao" placeholder="Instituição de Ensino">
            </div>
            <div class="input-container">
                <i class="fas fa-map-marker-alt"></i>
                <input type="text" id="endereco" placeholder="Endereço">
            </div>
            <div class="input-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="Nova senha">
            </div>
            <button type="submit" class="btn">Atualizar</button>
        </form>
        <div id="accountMessage"></div>
    </div>
</div>


<script>
    const API_BASE = 'http://localhost:8080';
    const token = localStorage.getItem('token');

    if (!token) window.location.href = 'login.html';

    function setAuthHeaders() {
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
    }

    function showMessage(msg, type='success') {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.textContent = msg;
        document.getElementById('resgatarMessage').appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }

    // Carregar saldo do aluno
    async function carregarSaldo() {
        const res = await fetch(`${API_BASE}/alunos/saldo`, { headers: setAuthHeaders() });
        const data = await res.json();
        document.querySelector('#saldoMoedas span').textContent = `${data.saldo || 0} moedas`;
    }

    // Carregar histórico de transações
    async function carregarHistorico() {
        const res = await fetch(`${API_BASE}/alunos/historico`, { headers: setAuthHeaders() });
        const data = await res.json();
        const div = document.getElementById('historicoTransacoes');
        div.innerHTML = '';
        data.forEach(t => {
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `<strong>${t.tipo}</strong><span>${t.descricao} - ${t.quantidade} moedas</span>`;
            div.appendChild(item);
        });
    }

    // Carregar vantagens disponíveis
    async function carregarVantagens() {
        const res = await fetch(`${API_BASE}/vantagens`, { headers: setAuthHeaders() });
        const data = await res.json();
        const select = document.getElementById('vantagemSelect');
        select.innerHTML = `<option value="">Selecione uma vantagem</option>`;
        data.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = `${v.nome} - ${v.custo} moedas`;
            select.appendChild(opt);
        });
    }

    async function carregarPerfil() {
    const res = await fetch(`${API_BASE}/alunos/perfil`, { headers: setAuthHeaders() });
    if (res.ok) {
        const data = await res.json();
        document.getElementById('name').value = data.nome || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('matricula').value = data.matricula || '';
        document.getElementById('curso').value = data.curso || '';
        document.getElementById('cpf').value = data.cpf || '';
        document.getElementById('rg').value = data.rg || '';
        document.getElementById('instituicao').value = data.instituicaoEnsino || '';
        document.getElementById('endereco').value = data.endereco || '';
    } else {
        console.error('Erro ao carregar perfil');
    }
}

// Atualizar dados do perfil
document.getElementById('accountForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = {
        nome: document.getElementById('name').value,
        email: document.getElementById('email').value,
        matricula: document.getElementById('matricula').value,
        curso: document.getElementById('curso').value,
        cpf: document.getElementById('cpf').value,
        rg: document.getElementById('rg').value,
        instituicaoEnsino: document.getElementById('instituicao').value,
        endereco: document.getElementById('endereco').value
    };
    const password = document.getElementById('password').value;
    if (password) formData.senha = password;

    const res = await fetch(`${API_BASE}/alunos/atualizarPorCpf?cpf=${formData.cpf}`, {
        method: 'PUT',
        headers: setAuthHeaders(),
        body: JSON.stringify(formData)
    });

    const msgDiv = document.getElementById('accountMessage');
    if (res.ok) {
        msgDiv.textContent = 'Perfil atualizado com sucesso!';
        msgDiv.style.color = 'green';
        document.getElementById('password').value = '';
        carregarPerfil(); // Atualiza os campos
    } else {
        const data = await res.json();
        msgDiv.textContent = data.error || 'Erro ao atualizar perfil';
        msgDiv.style.color = 'red';
    }
});
    // Resgatar vantagem
    document.getElementById('resgatarForm').addEventListener('submit', async e => {
        e.preventDefault();
        const vantagemId = document.getElementById('vantagemSelect').value;
        if (!vantagemId) return showMessage('Selecione uma vantagem', 'error');

        const res = await fetch(`${API_BASE}/alunos/resgatar/${vantagemId}`, {
            method: 'POST',
            headers: setAuthHeaders()
        });
        if (res.ok) {
            showMessage('Vantagem resgatada com sucesso!');
            carregarSaldo();
            carregarHistorico();
        } else {
            const data = await res.json();
            showMessage(data.error || 'Erro ao resgatar', 'error');
        }
    });

    // Inicialização
    carregarSaldo();
    carregarHistorico();
    carregarVantagens();
    carregarPerfil();
</script>
</body>
</html>
