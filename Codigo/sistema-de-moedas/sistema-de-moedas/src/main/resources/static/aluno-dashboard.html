<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Aluno - Sistema de Moedas Estudantis</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quantico:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Estilos Globais */
        :root {
            --primary-blue: #4e73df;
            --secondary-gray: #858796;
            --light-gray: #f8f9fc;
            --white: #ffffff;
            --dark-blue: #2e4ab1;
            --border-color: #e3e6f0;
            --text-dark: #5a5c69;
            --text-light: #b7b9cc;
        }

        body {
            font-family: Quantico, 'Roboto Condensed', sans-serif ;
            background-color: var(--light-gray);
        }

        /* Estrutura Principal */
        #wrapper {
            display: flex;
        }

        #content-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: hidden;
        }

        #content {
            flex: 1 0 auto;
        }

        /* 1. Sidebar (Menu Lateral) */
        .sidebar {
            width: 224px;
            min-height: 100vh;
            background-image: linear-gradient(180deg, var(--primary-blue) 10%, var(--dark-blue) 100%);
            transition: all 0.3s ease;
        }
        .sidebar-brand {
            height: 4.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            text-decoration: none;
        }
        .sidebar .nav-item {
            position: relative;
        }
        .sidebar .nav-link {
            display: block;
            padding: 1rem;
            color: var(--text-light);
            text-decoration: none;
            cursor: pointer;
        }
        .sidebar .nav-link i {
            font-size: 0.85rem;
            margin-right: 0.5rem;
            color: var(--text-light);
        }
        .sidebar .nav-link span {
            font-size: 0.85rem;
            font-weight: 600;
        }
        .sidebar .nav-item.active .nav-link {
            color: var(--white);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-item:hover .nav-link {
            color: var(--white);
        }
        .sidebar .sidebar-divider {
            margin: 0 1rem 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* 2. Topbar (Barra Superior) */
        .topbar {
            height: 4.375rem;
            margin-bottom: 1.5rem;
            background-color: var(--white);
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .topbar h1 {
            font-size: 1.25rem;
            color: var(--text-dark);
            margin-left: 1.5rem;
        }
        .logout-btn {
            background: #e74a3b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }
        .logout-btn:hover {
            background: #c73e30;
        }
        .vantagem-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-top-left-radius: 0.35rem;
        border-top-right-radius: 0.35rem;
    }


        /* 3. Conte√∫do da P√°gina */
        .container-fluid {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        /* Oculta abas inativas */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            border: 1px solid var(--border-color);
            border-radius: 0.35rem;
        }
        .card.shadow {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
        }
        .card-header {
            padding: 0.75rem 1.25rem;
            background-color: #f8f9fc;
            border-bottom: 1px solid var(--border-color);
        }
        .card-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-blue);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .vantagens-toolbar .input-group-text i {
            color: var(--secondary-gray);
        }
        .vantagens-toolbar .btn-outline-primary {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        .vantagens-toolbar .btn-outline-primary:hover {
            background-color: var(--primary-blue);
            color: var(--white);
        }
        .vantagem-card h5 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .vantagem-card p {
            color: var(--secondary-gray);
        }
        .vantagem-card .badge {
            background-color: var(--primary-blue);
        }

        /* Card de Resumo (Saldo) */
        .card-summary {
            border-left-width: 0.25rem;
        }
        .border-left-primary { border-left-color: var(--primary-blue) !important; }
        .text-primary { color: var(--primary-blue) !important; }
        .text-gray-300 { color: #dddfeb !important; }
        .text-gray-800 { color: #5a5c69 !important; }
        .text-xs { font-size: 0.7rem; }

        /* Estilos do Formul√°rio (para ficar parecido com Bootstrap) */
        .input-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .input-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            z-index: 3;
        }
        input.form-control, select.form-select {
            padding-left: 45px;
        }
        input.form-control:focus, select.form-select:focus {
             border-color: var(--primary-blue);
             box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
        }

        /* Bot√£o */
        .btn-primary {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        .btn-primary:hover {
            background-color: var(--dark-blue);
            border-color: var(--dark-blue);
        }
        
        /* Hist√≥rico */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table {
            width: 100%;
            margin-bottom: 1rem;
            color: #858796;
            border-collapse: collapse;
        }
        
        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid #e3e6f0;
            background-color: #f8f9fc;
            color: #4e73df;
            padding: 0.75rem;
            text-align: left;
        }
        
        .table tbody td {
            padding: 0.75rem;
            border-top: 1px solid #e3e6f0;
            vertical-align: middle;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .empty-message {
            text-align: center;
            padding: 2rem;
            color: #858796;
            font-style: italic;
        }

    </style>
</head>
<body>

<div id="wrapper">

    <ul class="navbar-nav sidebar">
        <a class="sidebar-brand" href="#">
            <i class="fas fa-coins me-2"></i>
            <span>Aluno</span>
        </a>

        <hr class="sidebar-divider my-0">

        <li class="nav-item active">
            <a class="nav-link" onclick="showTab('saldo', this)">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>

        <hr class="sidebar-divider">

        <li class="nav-item">
            <a class="nav-link" onclick="showTab('historico', this)">
                <i class="fas fa-fw fa-history"></i>
                <span>Hist√≥rico</span>
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link" onclick="showTab('vantagens', this)">
                <i class="fas fa-fw fa-gift"></i>
                <span>Resgatar Vantagens</span>
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link" onclick="showTab('conta', this)">
                <i class="fas fa-fw fa-user"></i>
                <span>Minha Conta</span>
            </a>
        </li>
    </ul>
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">

            <nav class="navbar navbar-expand navbar-light bg-white topbar static-top shadow">
                <h1 class="h3 mb-0 text-gray-800">Dashboard do Aluno</h1>

                <ul class="navbar-nav ms-auto me-3">
                    <li class="nav-item">
                        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt fa-sm fa-fw me-2"></i>Sair</button>
                    </li>
                </ul>
            </nav>
            <div class="container-fluid pt-4">

                <div id="saldo" class="tab-content active">
                    <div class="row">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card card-summary border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Saldo de Moedas</div>
                                            <div id="saldoMoedas" class="h5 mb-0 font-weight-bold text-gray-800">0 moedas</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-coins fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card card-summary border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Vantagens Resgatadas</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-gift fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h2 class="m-0">Bem-vindo!</h2>
                                </div>
                                <div class="card-body">
                                    <p>Use suas moedas para resgatar vantagens exclusivas. Acompanhe seu saldo e hist√≥rico pelo menu ao lado.</p>
                                    <p class="mb-0">Este √© seu painel de controle de estudante.</p>
                                    </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="historico" class="tab-content">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h2><i class="fas fa-history"></i> Hist√≥rico de Movimenta√ß√µes</h2>
                        </div>
                        <div class="card-body">
                            <div id="historicoMovimentacoes" class="table-responsive">
                                <!-- O conte√∫do ser√° preenchido dinamicamente via JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h2><i class="fas fa-gift"></i> Hist√≥rico de Vantagens Resgatadas</h2>
                        </div>
                        <div class="card-body">
                            <div id="historicoVantagens" class="table-responsive">
                                <!-- lista din√¢mica -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="vantagens" class="tab-content">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h2><i class="fas fa-gift"></i> Resgatar Vantagens</h2>
                                </div>
                                <div class="card-body">
                                    <div class="row vantagens-toolbar g-3 align-items-center mb-3">
                                        <div class="col-lg-7">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                <input type="text" id="vantagemSearch" class="form-control" placeholder="Buscar por t√≠tulo, empresa ou descri√ß√£o">
                                            </div>
                                        </div>
                                        <div class="col-lg-5 text-lg-end">
                                            <button type="button" id="atualizarVantagensBtn" class="btn btn-outline-primary">
                                                <i class="fas fa-sync-alt me-1"></i> Atualizar lista
                                            </button>
                                        </div>
                                    </div>
                                    <div id="resgatarMessage" class="mb-3"></div>
                                    <div id="vantagensLista" class="row g-3">
                                        <!-- Lista din√¢mica de vantagens -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="conta" class="tab-content">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h2><i class="fas fa-user"></i> Minha Conta</h2>
                                </div>
                                <div class="card-body">
                                    <form id="accountForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="input-container">
                                                    <i class="fas fa-user"></i>
                                                    <input type="text" id="name" class="form-control" placeholder="Nome" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="input-container">
                                                    <i class="fas fa-envelope"></i>
                                                    <input type="email" id="email" class="form-control" placeholder="Email" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="input-container">
                                                    <i class="fas fa-id-card"></i>
                                                    <input type="text" id="matricula" class="form-control" placeholder="Matr√≠cula" required readonly>
                                                </div>
                                            </div>
                                             <div class="col-md-6">
                                                <div class="input-container">
                                                    <i class="fas fa-book"></i>
                                                    <input type="text" id="curso" class="form-control" placeholder="Curso" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="input-container">
                                                    <i class="fas fa-id-badge"></i>
                                                    <input type="text" id="cpf" class="form-control" placeholder="CPF" required readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="input-container">
                                                    <i class="fas fa-id-badge"></i>
                                                    <input type="text" id="rg" class="form-control" placeholder="RG" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="input-container">
                                            <i class="fas fa-university"></i>
                                            <input type="text" id="instituicao" class="form-control" placeholder="Institui√ß√£o de Ensino">
                                        </div>
                                        <div class="input-container">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <input type="text" id="endereco" class="form-control" placeholder="Endere√ßo">
                                        </div>
                                        <div class="input-container">
                                            <i class="fas fa-lock"></i>
                                            <input type="password" id="password" class="form-control" placeholder="Nova senha (deixe em branco para n√£o alterar)">
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">Atualizar</button>
                                        <div id="accountMessage" class="mt-3"></div>
                                        
                                        <hr>

                                        <button type="button" class="btn btn-danger" id="deleteAccountBtn">
                                            <i class="fas fa-trash"></i> Excluir Conta
                                        </button>
                                        <div id="deleteMessage" class="mt-3"></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
    const API_BASE = 'http://localhost:8080';
    const token = localStorage.getItem('token');
    let vantagensDisponiveis = [];
    const vantagemSearchInput = document.getElementById('vantagemSearch');
    const vantagensLista = document.getElementById('vantagensLista');
    
    emailjs.init('f5FkYa1QVg9rO_OHK');

    emailjs.init('f5FkYa1QVg9rO_OHK');

    if (!token) window.location.href = 'login.html';

    function setAuthHeaders() {
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
    }

    // FUN√á√ÉO showTab ATUALIZADA para funcionar com o menu
    function showTab(tabName, element) {
        // Esconde todos os conte√∫dos
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        // Mostra o conte√∫do da aba clicada
        document.getElementById(tabName).classList.add('active');

        // Remove a classe 'active' de todos os itens do menu
        document.querySelectorAll('.sidebar .nav-item').forEach(t => t.classList.remove('active'));
        // Adiciona a classe 'active' ao item de menu (li) que foi clicado
        if (element) {
            element.closest('li.nav-item').classList.add('active');
        }

        // Carregar dados espec√≠ficos de cada aba
        if (tabName === 'historico') {
            carregarHistoricoMovimentacoes();
            carregarHistoricoVantagens();
        }
        if (tabName === 'vantagens') {
            carregarVantagens();
            const msgDiv = document.getElementById('resgatarMessage');
            if (msgDiv) msgDiv.innerHTML = '';
        }
    }

    // Fun√ß√£o para exibir mensagens de feedback (Bootstrap alerts)
    function showMessage(msg, type='success', containerId = 'resgatarMessage') {
        const msgDiv = document.getElementById(containerId);
        if (!msgDiv) return;
        
        const alertType = (type === 'success') ? 'alert-success' : 'alert-danger';
        const alertHTML = `
            <div class="alert ${alertType} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        msgDiv.innerHTML = alertHTML;
        
        // Remove a mensagem ap√≥s 5 segundos
        setTimeout(() => {
            const alert = msgDiv.querySelector('.alert');
            if(alert) {
                new bootstrap.Alert(alert).close();
            }
        }, 5000);
    }
    
    function showAccountMessage(msg, type='success') {
        const msgDiv = document.getElementById('accountMessage');
        msgDiv.textContent = msg;
        msgDiv.style.color = (type === 'success') ? 'green' : 'red';
    }
    
    function showDeleteMessage(msg, type='success') {
        const msgDiv = document.getElementById('deleteMessage');
        msgDiv.textContent = msg;
        msgDiv.style.color = (type === 'success') ? 'green' : 'red';
    }


    // Carregar saldo do aluno (usa /alunos/perfil para pegar id e depois /transacoes/aluno/{id}/saldo)
    async function carregarSaldo() {
        try {
            // tenta obter perfil do aluno
            const perfilRes = await fetch(`${API_BASE}/alunos/perfil`, { headers: setAuthHeaders() });
            if (!perfilRes.ok) throw new Error('Erro ao buscar perfil');
            const perfil = await perfilRes.json();
            const alunoId = perfil?.id;
            if (!alunoId) throw new Error('Aluno n√£o encontrado');

            const res = await fetch(`${API_BASE}/transacoes/aluno/${alunoId}/saldo`, { headers: setAuthHeaders() });
            if (!res.ok) throw new Error('Erro ao buscar saldo');
            const data = await res.json();
            const saldo = data?.balance ?? data?.saldo ?? 0;
            document.getElementById('saldoMoedas').textContent = `${saldo} moedas`;
        } catch (error) {
            console.error(error);
            document.getElementById('saldoMoedas').textContent = 'Erro!';
        }
    }

    function formatarDataHora(dataString) {
        if (!dataString) return 'Data indispon√≠vel';
        const data = new Date(dataString);
        if (Number.isNaN(data.getTime())) return dataString;
        return data.toLocaleString('pt-BR');
    }

    async function carregarHistoricoMovimentacoes() {
        const container = document.getElementById('historicoMovimentacoes');
        if (!container) return;
        container.innerHTML = '<p>Carregando hist√≥rico...</p>';

        try {
            const perfilRes = await fetch(`${API_BASE}/alunos/perfil`, { headers: setAuthHeaders() });
            if (!perfilRes.ok) throw new Error('Erro ao buscar perfil');
            const perfil = await perfilRes.json();
            const alunoId = perfil?.id;
            if (!alunoId) throw new Error('Aluno n√£o encontrado');

            const [transacoesRes, resgatesRes] = await Promise.all([
                fetch(`${API_BASE}/alunos/${alunoId}/transacoes`, { headers: setAuthHeaders() }),
                fetch(`${API_BASE}/vantagens/resgates`, { headers: setAuthHeaders() })
            ]);

            const transacoes = transacoesRes.ok ? await transacoesRes.json() : [];
            const resgates = resgatesRes.ok ? await resgatesRes.json() : [];

            const eventos = [];

            transacoes.forEach(t => {
                eventos.push({
                    tipo: 'Recebido',
                    origem: t.professor?.nome || t.professorNome || t.professor_name || t.professorName || 'Professor',
                    origemTipo: 'Professor',
                    quantidade: t.quantidade || 0,
                    descricao: t.mensagem || 'Moedas recebidas',
                    data: t.criadoEm
                });
            });

            resgates.forEach(r => {
                eventos.push({
                    tipo: 'Resgate',
                    origem: r.empresa || r.empresaNome || r.vantagem?.empresa?.nome || 'Empresa parceira',
                    origemTipo: 'Empresa',
                    quantidade: -(r.custoMoedas || 0),
                    descricao: r.titulo || r.descricao || 'Vantagem resgatada',
                    data: r.resgatadoEm
                });
            });

            if (!eventos.length) {
                container.innerHTML = '<p>Voc√™ ainda n√£o possui movimenta√ß√µes.</p>';
                return;
            }

            eventos.sort((a, b) => new Date(b.data) - new Date(a.data));

            const table = document.createElement('table');
            table.className = 'table table-striped';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Origem</th>
                        <th>Quantidade</th>
                        <th>Descri√ß√£o</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

            const tbody = table.querySelector('tbody');
            eventos.forEach(evento => {
                const tr = document.createElement('tr');
                const quantidadeFormatada = evento.quantidade >= 0
                    ? `+ ${evento.quantidade} moedas`
                    : `- ${Math.abs(evento.quantidade)} moedas`;

                tr.innerHTML = `
                    <td>${evento.tipo}</td>
                    <td>${evento.origem}</td>
                    <td class="${evento.quantidade >= 0 ? 'text-success' : 'text-danger'}">${quantidadeFormatada}</td>
                    <td>${evento.descricao}</td>
                    <td>${formatarDataHora(evento.data)}</td>
                `;
                tbody.appendChild(tr);
            });

            container.innerHTML = '';
            container.appendChild(table);
        } catch (error) {
            console.error(error);
            container.innerHTML = '<p class="text-danger">Erro ao carregar hist√≥rico.</p>';
        }
    }

    async function carregarHistoricoVantagens() {
        const container = document.getElementById('historicoVantagens');
        if (!container) return;
        container.innerHTML = '<p>Carregando hist√≥rico...</p>';

        try {
            const res = await fetch(`${API_BASE}/vantagens/resgates`, { headers: setAuthHeaders() });
            if (!res.ok) throw new Error('Erro ao buscar hist√≥rico de vantagens');
            const data = await res.json();

            if (!data || !data.length) {
                container.innerHTML = '<p>Voc√™ ainda n√£o resgatou nenhuma vantagem.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table table-striped';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Vantagem</th>
                        <th>Empresa</th>
                        <th>Custo</th>
                        <th>Resgatado em</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

            const tbody = table.querySelector('tbody');
            data.forEach(resgate => {
                const empresaNome = resgate.empresa || resgate.empresaNome || resgate.vantagem?.empresa?.nome || 'Empresa parceira';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${resgate.titulo || 'Vantagem'}</td>
                    <td>${empresaNome}</td>
                    <td>${resgate.custoMoedas || 0} moedas</td>
                    <td>${formatarDataHora(resgate.resgatadoEm)}</td>
                `;
                tbody.appendChild(tr);
            });

            container.innerHTML = '';
            container.appendChild(table);
        } catch (error) {
            console.error(error);
            container.innerHTML = '<p class="text-danger">Erro ao carregar hist√≥rico de vantagens.</p>';
        }
    }

    function escapeHtml(str = '') {
        const value = (str === null || str === undefined) ? '' : String(str);
        return value.replace(/[&<>"']/g, match => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        }[match]));
    }

    function filtrarVantagens(termo = '') {
        const normalized = termo.trim().toLowerCase();
        if (!normalized) return [...vantagensDisponiveis];
        return vantagensDisponiveis.filter(v => {
            const alvo = `${v.titulo || ''} ${v.descricao || ''} ${(v.empresa?.nomeFantasia || v.empresa?.nome || '')}`.toLowerCase();
            return alvo.includes(normalized);
        });
    }

    // ================================
//  LISTAR VANTAGENS COM IMAGEM
// ================================
async function carregarVantagens() {
    try {
        const response = await fetch(`${API_BASE}/vantagens/listar`, {
            headers: setAuthHeaders()
        });

        if (!response.ok) {
            throw new Error("Erro ao carregar vantagens");
        }

        vantagensDisponiveis = await response.json();

        renderizarVantagens(vantagensDisponiveis);

    } catch (error) {
        console.error(error);
        showMessage("Erro ao carregar vantagens.", "danger");
    }
}


// ================================
//   RENDERIZA√á√ÉO DOS CARDS
// ================================


async function trocarVantagem(vantagemId, triggerBtn = null) {
    if (!vantagemId) {
        showMessage('Selecione uma vantagem v√°lida.', 'error');
        return;
    }

    // ---------------------------------------
    // üîÑ Estado do bot√£o (loading)
    // ---------------------------------------
    const button = triggerBtn;
    const originalContent = button ? button.innerHTML : '';

    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Resgatando';
    }

    try {
        const res = await fetch(`${API_BASE}/vantagens/trocar/${vantagemId}`, {
            method: 'POST',
            headers: setAuthHeaders()
        });

        if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            showMessage(data.message || 'N√£o foi poss√≠vel resgatar esta vantagem.', 'error');
            return;
        }

        showMessage("üéâ Vantagem resgatada com sucesso!", "success");

        // ---------------------------------------
        // üîÑ Atualiza√ß√µes ap√≥s resgate
        // ---------------------------------------
        await Promise.all([
            carregarSaldo(),
            carregarHistoricoMovimentacoes?.(),
            carregarHistoricoVantagens(),
            carregarVantagens(false)
        ]);

        // ---------------------------------------
        // üî• Enviar Email (se houver nome e email)
        // ---------------------------------------
        const alunoNome  = document.getElementById('name')?.value;
        const alunoEmail = document.getElementById('email')?.value;
        const vantagem = vantagensDisponiveis?.find(v => v.id == vantagemId);

        // Determina a URL/imagem (prioridade: img URL > base64 > placeholder)
        const imagemUrl = vantagem?.img
            ? vantagem.img
            : (vantagem?.imagemBase64
                ? `data:image/jpeg;base64,${vantagem.imagemBase64}`
                : PLACEHOLDER_IMAGE_URL);

        if (alunoNome && alunoEmail && vantagem) {
            // Gera c√≥digo e QR que apontam para uma URL de valida√ß√£o
            const codigoResgate = gerarCodigoAleatorio(10);
            // Crie um endpoint no backend para validar o c√≥digo (recomendo salvar esse c√≥digo l√°)
            const validarUrl = `${API_BASE}/validar-resgate?code=${encodeURIComponent(codigoResgate)}`;

            let qrDataUrl = null;
            try {
                qrDataUrl = await gerarQRCodeDataUrl(validarUrl);
            } catch (qrErr) {
                console.error('Erro ao gerar QR:', qrErr);
            }

            const templateParams = {
                to_name: alunoNome,
                to_email: alunoEmail,
                vantagem_titulo: vantagem.titulo,
                vantagem_descricao: vantagem.descricao,
                empresa_nome: vantagem.empresa?.nomeFantasia || vantagem.empresa?.nome || "Empresa parceira",
                custo: `${vantagem.custoMoedas} moedas`,
                data_resgate: new Date().toLocaleString('pt-BR'),
                vantagem_imagem: imagemUrl,
                codigo_resgate: codigoResgate,   // texto vis√≠vel no email
                qr_image: qrDataUrl               // Data URL do QR (use <img src="{{qr_image}}"> no template)
            };

            emailjs.send('service_eb33j38', 'template_0985ayl', templateParams)
                .then(() => console.log('Email enviado com c√≥digo e QR!'))
                .catch((err) => {
                    console.error(err);
                    showMessage('Vantagem resgatada, mas erro ao enviar email.', 'error');
                });
        }

    } catch (error) {
        console.error(error);
        showMessage("Erro inesperado ao resgatar vantagem!", "danger");

    } finally {
        // ---------------------------------------
        // üîì Restaurar bot√£o
        // ---------------------------------------
        if (button) {
            button.disabled = false;
            button.innerHTML = originalContent;
        }
    }
}

function renderizarVantagens(lista) {
    vantagensLista.innerHTML = "";

    if (!lista || lista.length === 0) {
        vantagensLista.innerHTML = `
            <p class="text-center text-muted">Nenhuma vantagem dispon√≠vel.</p>
        `;
        return;
    }

    lista.forEach(v => {
        const card = document.createElement("div");
        card.className = "col-md-4";

        // üìå Prioridade da imagem:
        // 1 - URL enviada pelo backend (v.img)
        // 2 - Base64 (v.imagemBase64)
        // 3 - Placeholder
        const imagem = v.img
            ? v.img
            : (v.imagemBase64 
                ? `data:image/jpeg;base64,${v.imagemBase64}`
                : "https://via.placeholder.com/300x150?text=Sem+Imagem");

        card.innerHTML = `
            <div class="card vantagem-card shadow h-100">
                <img src="${imagem}" class="card-img-top" alt="Imagem da vantagem">

                <div class="card-body">
                    <h5 class="card-title">${v.titulo}</h5>
                    <p class="card-text">${v.descricao}</p>

                    <span class="badge bg-primary">${v.custoMoedas} moedas</span>

                    <button class="btn btn-success w-100 mt-2" onclick="trocarVantagem(${v.id})">
                        Resgatar
                    </button>
                </div>
            </div>
        `;

        vantagensLista.appendChild(card);
    });
}


    

    
    if (vantagemSearchInput) {
        vantagemSearchInput.addEventListener('input', event => {
            const termo = event.target.value || '';
            renderVantagens(filtrarVantagens(termo));
        });
    }

    const atualizarVantagensBtn = document.getElementById('atualizarVantagensBtn');
    if (atualizarVantagensBtn) {
        atualizarVantagensBtn.addEventListener('click', () => carregarVantagens());
    }

    if (vantagensLista) {
        vantagensLista.addEventListener('click', event => {
            const button = event.target.closest('[data-vantagem-id]');
            if (!button) return;
            trocarVantagem(button.dataset.vantagemId, button);
        });
    }

    // Carregar dados do perfil na aba "Conta"
    async function carregarPerfil() {
        try {
            const res = await fetch(`${API_BASE}/alunos/perfil`, { headers: setAuthHeaders() });
            if (res.ok) {
                const data = await res.json();
                document.getElementById('name').value = data.nome || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('matricula').value = data.matricula || '';
                document.getElementById('curso').value = data.curso || '';
                document.getElementById('cpf').value = data.cpf || '';
                document.getElementById('rg').value = data.rg || '';
                document.getElementById('instituicao').value = data.instituicaoEnsino || '';
                document.getElementById('endereco').value = data.endereco || '';
            } else {
                console.error('Erro ao carregar perfil');
                showAccountMessage('Erro ao carregar dados do perfil.', 'error');
            }
        } catch (error) {
            console.error(error);
            showAccountMessage('Erro de conex√£o ao carregar perfil.', 'error');
        }
    }

    // Atualizar dados do perfil
    document.getElementById('accountForm').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = {
            nome: document.getElementById('name').value,
            email: document.getElementById('email').value,
            matricula: document.getElementById('matricula').value,
            curso: document.getElementById('curso').value,
            cpf: document.getElementById('cpf').value,
            rg: document.getElementById('rg').value,
            instituicaoEnsino: document.getElementById('instituicao').value,
            endereco: document.getElementById('endereco').value
        };
        const password = document.getElementById('password').value;
        if (password) formData.senha = password;

        try {
            const res = await fetch(`${API_BASE}/alunos/atualizarPorCpf?cpf=${formData.cpf}`, {
                method: 'PUT',
                headers: setAuthHeaders(),
                body: JSON.stringify(formData)
            });

            if (res.ok) {
                showAccountMessage('Perfil atualizado com sucesso!', 'success');
                document.getElementById('password').value = '';
                carregarPerfil(); // Atualiza os campos
            } else {
                const data = await res.json();
                showAccountMessage(data.error || 'Erro ao atualizar perfil', 'error');
            }
        } catch (error) {
            console.error(error);
            showAccountMessage('Erro de conex√£o ao atualizar.', 'error');
        }
    });

    // Excluir conta do aluno
    document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
        const id = document.getElementById('matricula').value;

        if (!id) {
            showDeleteMessage('Matr√≠cula n√£o encontrada. N√£o foi poss√≠vel excluir a conta.', 'error');
            return;
        }

        if (!confirm('Tem certeza que deseja excluir permanentemente sua conta? Esta a√ß√£o n√£o poder√° ser desfeita.')) {
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/alunos/deletarAluno?id=${id}`, {
                method: 'DELETE',
                headers: setAuthHeaders()
            });

            if (res.ok) {
                showDeleteMessage('Conta exclu√≠da com sucesso! Redirecionando...', 'success');
                localStorage.removeItem('token');
                setTimeout(() => window.location.href = 'login.html', 3000);
            } else {
                 const data = await res.json();
                showDeleteMessage(data.error || 'Erro ao excluir conta.', 'error');
            }
        } catch (error) {
            console.error('Erro:', error);
            showDeleteMessage('Erro de conex√£o ao excluir conta.', 'error');
        }
    });


    // Inicializa√ß√£o (carrega tudo ao abrir a p√°gina)
    document.addEventListener('DOMContentLoaded', () => {
        carregarSaldo();
        carregarHistoricoMovimentacoes();
        carregarHistoricoVantagens();
        carregarVantagens();
        carregarPerfil();
    });

    // Gera um c√≥digo aleat√≥rio seguro (usa crypto se dispon√≠vel)
    function gerarCodigoAleatorio(tamanho = 8) {
        const bytes = new Uint8Array(tamanho);
        if (window.crypto && crypto.getRandomValues) {
            crypto.getRandomValues(bytes);
        } else {
            // fallback simples (menos seguro)
            for (let i = 0; i < bytes.length; i++) bytes[i] = Math.floor(Math.random() * 256);
        }
        let s = '';
        for (const b of bytes) s += (b % 36).toString(36);
        return s.toUpperCase();
    }

    // Gera DataURL do QR (usa a lib qrcode j√° carregada)
    async function gerarQRCodeDataUrl(texto) {
        if (window.QRCode && QRCode.toDataURL) {
            return QRCode.toDataURL(String(texto || ''), { margin: 1, width: 400 });
        }
        throw new Error('Biblioteca QRCode n√£o encontrada');
    }

    // Use placeholder com URL completa ‚Äî evita erro de resolu√ß√£o
    const PLACEHOLDER_IMAGE_URL = 'https://via.placeholder.com/300x150?text=Sem+Imagem';
</script>
</body>
</html>
